---
title: "Untitled"
editor_options: 
  chunk_output_type: console
---


```{r}
library(tidyverse)
federalist <- ProbBayes::federalist_word_study |>
  rename("Article" = "Name") |>
  select(Article, Total, word, N, Authorship, Disputed) |>
  mutate(Authorship = as.character(Authorship)) |>
  mutate(Authorship = ifelse(Authorship == "", "Jay", Authorship),
         word = as.character(word),
         Disputed = as.character(Disputed),
         Article = as.character(Article))
ham_df <- federalist |>
  filter(word == "an") |>
  filter(Authorship == "Hamilton", Disputed == "no")
mad_df <- federalist |>
  filter(word == "an") |>
  filter(Authorship == "Madison", Disputed == "no")

n1_vec <- ham_df$Total
n2_vec <- mad_df$Total
y1_vec <- ham_df$N
y2_vec <- mad_df$N

G <- 10000
a_alpha <- 0.001
b_alpha <- 0.001

a_beta <- 0.001
b_beta <- 0.001



fed_metropolis <- function(y_vec, n_vec, G, a_alpha, b_alpha, a_beta, b_beta, alpha_sd, beta_sd){
  alpha <- a_alpha/b_alpha; 
  beta <- a_beta/b_beta; 
  p_vec <- beta / (beta+n_vec/1000)
  alpha_acc <- beta_acc <- rep(0, G)
  ALPHA <- BETA <- rep(NA, G)
  for(g in 1:G){
    alpha_prop <- rnorm(1, alpha, alpha_sd)
    if(alpha_prop > 0){
      r <- sum(dnbinom(y_vec, alpha_prop, p_vec, log = T)) -
      sum(dnbinom(y_vec, alpha, p_vec, log = T)) +
      dgamma(alpha_prop, a_alpha, b_alpha, log = T) -
      dgamma(alpha, a_alpha, b_beta, log = T)
      if(log(runif(1)) < r){
        alpha <- alpha_prop
        alpha_acc[g] <- 1
      }
    }
  
    beta_prop <- rnorm(1, beta, beta_sd)
    if(beta_prop > 0){
      p_prop_vec <- beta_prop/(beta_prop + n_vec/1000)
      r <- sum(dnbinom(y_vec, alpha, p_prop_vec, log = T)) -
        sum(dnbinom(y_vec, alpha, p_vec, log = T)) +
        dgamma(beta_prop, a_beta, b_beta, log = T) -
        dgamma(beta, a_beta, b_beta, log = T)
      if(log(runif(1)) < r){
        beta <- beta_prop
        beta_acc[g] <- 1
        p_vec <- p_prop_vec
      }
    }
  
    
    ALPHA[g] <- alpha
    BETA[g] <- beta
  }
  
  ALPHA <- ALPHA[(G-5000):G]
  BETA <- BETA[(G-5000):G]
  return(list(ALPHA = ALPHA, BETA = BETA, MU = ALPHA/BETA, accept_vec = c(mean(alpha_acc), mean(beta_acc))))
}




alpha_sd <- 1
beta_sd <- 0.5
ret_ham <- fed_metropolis(y1_vec, n1_vec, G, a_alpha, b_alpha, a_beta, b_beta, alpha_sd = 3, beta_sd = 0.75)
ret_ham$accept_vec
ret_mad <- fed_metropolis(y2_vec, n2_vec, G, a_alpha, b_alpha, a_beta, b_beta, alpha_sd = 5, beta_sd = 0.5)
ret_mad$accept_vec

plot(ret_ham$MU, type = "l")
plot(ret_mad$MU, type = "l")

plot(ret_ham$MU/ret_mad$MU, type = "l")
```